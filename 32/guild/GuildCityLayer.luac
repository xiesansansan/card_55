slot0 = class("GuildCityLayer", require("common.BaseLayer"), function ()
	return UIWrap.newRootLayer({
		fullScreen = false,
		color = cc.c4b(0, 0, 0, 150)
	})
end)
slot0.uiTree = {
	{
		name = "myBox",
		cType = "MsgBoxBg",
		params = {
			posApt = 1,
			image = "tc_1.png",
			pos = {
				x = 568,
				y = 320
			},
			size = {
				width = 684,
				height = 534
			}
		},
		children = {
			{
				name = "untitled2",
				cType = "Sprite",
				params = {
					image = "tc_4.png",
					pos = {
						x = 361,
						y = 516.02
					}
				},
				children = {
					{
						name = "untitled3",
						cType = "Label",
						params = {
							fontSize = 24,
							pos = {
								x = 144,
								y = 18
							},
							text = TR("帮派领地")
						},
						children = {}
					}
				}
			},
			{
				name = "untitled4",
				cType = "Node",
				custom = {
					{
						value = 1,
						name = "cityType",
						type = "integer"
					}
				},
				params = {
					pos = {
						x = 114,
						y = 430
					}
				},
				children = {
					{
						name = "untitled5",
						cType = "Sprite",
						params = {
							scale = 0.75,
							image = "jhjs_2.png",
							pos = {
								x = -42.37,
								y = 15.66
							}
						},
						children = {}
					},
					{
						name = "untitled10",
						cType = "Label",
						params = {
							fontSize = 18,
							childName = "nameLabel",
							outlineColor = {
								g = 37,
								r = 37,
								b = 37
							},
							pos = {
								x = -40.79,
								y = 18.02
							},
							size = {
								width = 25,
								height = 100
							},
							text = TR("小型门派")
						},
						children = {}
					},
					{
						name = "untitled7",
						cType = "Sprite",
						params = {
							image = "bp_51.png",
							pos = {
								x = 27.97,
								y = 33.19
							}
						},
						children = {}
					},
					{
						name = "untitled8",
						cType = "Label",
						params = {
							fontSize = 18,
							color = {
								g = 37,
								r = 37,
								b = 37
							},
							pos = {
								x = 25.94,
								y = -13.51
							},
							text = TR("可占领数量")
						},
						children = {}
					},
					{
						name = "untitled9",
						cType = "Label",
						params = {
							fontSize = 18,
							childName = "numLabel",
							text = "0/10",
							isRichText = true,
							color = {
								g = 168,
								r = 139,
								b = 87
							},
							outlineColor = {
								g = 37,
								r = 37,
								b = 37
							},
							pos = {
								x = 22.05,
								y = -33.22
							}
						},
						children = {}
					}
				}
			},
			{
				name = "untitled11",
				cType = "Node",
				custom = {
					{
						value = 2,
						name = "cityType",
						type = "integer"
					}
				},
				params = {
					pos = {
						x = 114,
						y = 300
					}
				},
				children = {
					{
						name = "untitled12",
						cType = "Sprite",
						params = {
							scale = 0.75,
							image = "jhjs_2.png",
							pos = {
								x = -42.37,
								y = 15.66
							}
						},
						children = {}
					},
					{
						name = "untitled13",
						cType = "Label",
						params = {
							fontSize = 18,
							childName = "nameLabel",
							color = {
								g = 167,
								r = 92,
								b = 187
							},
							outlineColor = {
								g = 37,
								r = 37,
								b = 37
							},
							pos = {
								x = -40.79,
								y = 18.02
							},
							size = {
								width = 25,
								height = 100
							},
							text = TR("中型门派")
						},
						children = {}
					},
					{
						name = "untitled14",
						cType = "Sprite",
						params = {
							image = "bp_52.png",
							pos = {
								x = 27.97,
								y = 33.19
							}
						},
						children = {}
					},
					{
						name = "untitled15",
						cType = "Label",
						params = {
							fontSize = 18,
							color = {
								g = 37,
								r = 37,
								b = 37
							},
							pos = {
								x = 25.94,
								y = -13.51
							},
							text = TR("可占领数量")
						},
						children = {}
					},
					{
						name = "untitled16",
						cType = "Label",
						params = {
							fontSize = 18,
							childName = "numLabel",
							text = "0/10",
							isRichText = true,
							color = {
								g = 168,
								r = 139,
								b = 87
							},
							outlineColor = {
								g = 37,
								r = 37,
								b = 37
							},
							pos = {
								x = 22.05,
								y = -33.22
							}
						},
						children = {}
					}
				}
			},
			{
				name = "untitled17",
				cType = "Node",
				custom = {
					{
						value = 3,
						name = "cityType",
						type = "integer"
					}
				},
				params = {
					pos = {
						x = 114,
						y = 168
					}
				},
				children = {
					{
						name = "untitled18",
						cType = "Sprite",
						params = {
							scale = 0.75,
							image = "jhjs_2.png",
							pos = {
								x = -42.37,
								y = 15.66
							}
						},
						children = {}
					},
					{
						name = "untitled19",
						cType = "Label",
						params = {
							fontSize = 18,
							childName = "nameLabel",
							color = {
								g = 51,
								r = 170,
								b = 221
							},
							outlineColor = {
								g = 37,
								r = 37,
								b = 37
							},
							pos = {
								x = -40.79,
								y = 18.02
							},
							size = {
								width = 25,
								height = 100
							},
							text = TR("大型门派")
						},
						children = {}
					},
					{
						name = "untitled20",
						cType = "Sprite",
						params = {
							image = "bp_53.png",
							pos = {
								x = 27.97,
								y = 33.19
							}
						},
						children = {}
					},
					{
						name = "untitled21",
						cType = "Label",
						params = {
							fontSize = 18,
							color = {
								g = 37,
								r = 37,
								b = 37
							},
							pos = {
								x = 25.94,
								y = -13.51
							},
							text = TR("可占领数量")
						},
						children = {}
					},
					{
						name = "untitled22",
						cType = "Label",
						params = {
							fontSize = 18,
							childName = "numLabel",
							text = "0/10",
							isRichText = true,
							color = {
								g = 168,
								r = 139,
								b = 87
							},
							outlineColor = {
								g = 37,
								r = 37,
								b = 37
							},
							pos = {
								x = 22.05,
								y = -33.22
							}
						},
						children = {}
					}
				}
			},
			{
				name = "untitled23",
				cType = "Sprite",
				params = {
					image = "bzlj_7.png",
					pos = {
						x = 49,
						y = 94
					}
				},
				children = {}
			},
			{
				name = "untitled24",
				cType = "Sprite",
				params = {
					image = "bzlj_7.png",
					pos = {
						x = 49,
						y = 69
					}
				},
				children = {}
			},
			{
				name = "getNumLabel",
				cType = "Label",
				params = {
					fontSize = 18,
					isRichText = true,
					anchor = {
						x = 0,
						y = 0.5
					},
					color = {
						g = 37,
						r = 37,
						b = 37
					},
					pos = {
						x = 59,
						y = 94
					},
					text = TR("我方已占领2座门派")
				},
				children = {}
			},
			{
				name = "untitled26",
				cType = "Label",
				params = {
					fontSize = 18,
					anchor = {
						x = 0,
						y = 0.5
					},
					color = {
						g = 37,
						r = 37,
						b = 37
					},
					pos = {
						x = 59,
						y = 58
					},
					size = {
						width = 160,
						height = 40
					},
					text = TR("帮派等级越高占领门派数量越多")
				},
				children = {}
			},
			{
				name = "mapNode",
				cType = "Sprite",
				params = {
					image = "bp_56.png",
					pos = {
						x = 444.69,
						y = 293.34
					}
				},
				children = {
					{
						name = "citywarView",
						cType = "Sprite",
						params = {
							zOrder = 10,
							hide = true,
							image = "c_61.png",
							anchor = {
								x = 0,
								y = 0
							},
							pos = {
								x = 137.85,
								y = 137.73
							}
						},
						children = {}
					}
				}
			},
			{
				name = "mineSprite",
				cType = "Sprite",
				params = {
					image = "bp_54.png",
					pos = {
						x = 272,
						y = 468
					}
				},
				children = {}
			},
			{
				name = "mineLabel",
				cType = "Label",
				params = {
					fontSize = 18,
					color = {
						g = 168,
						r = 139,
						b = 87
					},
					outlineColor = {
						g = 37,
						r = 37,
						b = 37
					},
					pos = {
						x = 327,
						y = 468
					},
					text = TR("本方帮派")
				},
				children = {}
			},
			{
				name = "otherSprite",
				cType = "Sprite",
				params = {
					image = "bp_101.png",
					pos = {
						x = 543,
						y = 468
					}
				},
				children = {}
			},
			{
				name = "otherLabel",
				cType = "Label",
				params = {
					fontSize = 18,
					color = {
						g = 255,
						r = 255,
						b = 255
					},
					outlineColor = {
						g = 37,
						r = 37,
						b = 37
					},
					pos = {
						x = 593,
						y = 468
					},
					text = TR("魔教入侵")
				},
				children = {}
			},
			{
				name = "giveUpBtn",
				cType = "Button",
				params = {
					image = "c_27.png",
					clickAction = "onGiveUpCallback",
					pos = {
						x = 305,
						y = 60
					},
					titleText = TR("放弃领地")
				},
				children = {}
			},
			{
				name = "changeHomeBtn",
				cType = "Button",
				params = {
					image = "c_27.png",
					clickAction = "onChangeHomeBtn",
					pos = {
						x = 446,
						y = 60
					},
					titleText = TR("更换总部")
				},
				children = {}
			},
			{
				name = "rewardBtn",
				cType = "Button",
				params = {
					image = "c_27.png",
					clickAction = "onCityRewardCallback",
					pos = {
						x = 585,
						y = 60
					},
					titleText = TR("领地奖励")
				},
				children = {
					{
						name = "untitled37",
						cType = "RedDot",
						params = {
							subKey = "CanReward",
							moduleId = 5404
						},
						children = {}
					}
				}
			},
			{
				name = "untitled38",
				cType = "Sprite",
				params = {
					image = "bp_92.png",
					pos = {
						x = 412,
						y = 468
					}
				},
				children = {}
			},
			{
				name = "untitled39",
				cType = "Label",
				params = {
					fontSize = 18,
					color = {
						g = 65,
						r = 192,
						b = 65
					},
					outlineColor = {
						g = 37,
						r = 37,
						b = 37
					},
					pos = {
						x = 463,
						y = 468
					},
					text = TR("敌方帮派")
				},
				children = {}
			},
			{
				name = "untitled40",
				cType = "Effect",
				params = {
					dataFile = "effect_ui_dituyilan",
					pos = {
						x = 272.21,
						y = 465.73
					}
				},
				children = {}
			},
			{
				name = "untitled41",
				cType = "Effect",
				params = {
					dataFile = "effect_ui_mojiaoruqin_xiaochengbiao",
					pos = {
						x = 543.96,
						y = 465.06
					}
				},
				children = {}
			}
		}
	}
}
slot1 = 3
slot0.ctor = function (slot0, slot1)
	slot0.curViewPos = slot1.curViewPos
	slot0.callback = slot1 and slot1.callback
	slot0.bornCityPos = slot1.bornCityPos
	slot0.bornCityId = slot1.bornCityId

	slot0.super.ctor(slot0, {
		swallow = true
	})
	slot0.initUI(slot0)

	return 
end
slot0.initUI = function (slot0)
	slot0.createUITree(slot0, function (slot0, slot1)
		if slot0.name == "citywarView" and slot0.curViewPos then
			slot1.pos = cc.p(math.abs(slot0.curViewPos.x/6.154), math.abs(slot0.curViewPos.y/6.154))
		end

		return 
	end)
	slot0.requestWorldBossInfo(slot0)
	slot0.getCityWarInfo(slot0)

	return 
end
slot0.refreshTopCityNum = function (slot0)
	slot1 = {
		0,
		0,
		0
	}
	slot4 = {
		Utility.getConfigItems("GuildLvRelation")[(PlayerAttrObj:getPlayerAttrByName("GuildInfo").GuildLevel == 0 and 1) or PlayerAttrObj:getPlayerAttrByName("GuildInfo").GuildLevel].smallCityNum,
		Utility.getConfigItems("GuildLvRelation")[(PlayerAttrObj.getPlayerAttrByName("GuildInfo").GuildLevel == 0 and 1) or PlayerAttrObj.getPlayerAttrByName("GuildInfo").GuildLevel].midCityNum,
		Utility.getConfigItems("GuildLvRelation")[(PlayerAttrObj.getPlayerAttrByName("GuildInfo").GuildLevel == 0 and 1) or PlayerAttrObj.getPlayerAttrByName("GuildInfo").GuildLevel].bigCityNum
	}

	for slot8, slot9 in ipairs(slot0.cityIdInfo[1]) do
		if CitywarCityConfig.items[tonumber(slot9)].cityType <= 3 then
			slot1[tonumber(slot10)] = slot1[tonumber(slot10)] + 1
		end
	end

	for slot8, slot9 in ipairs(slot0.getCustomChildren(slot0, slot0.myBox, "cityType")) do
		slot9.numLabel:setString(TR("%s%s/%s", (slot1[slot8] == slot4[slot8] and "#ff0000") or "#37ff40", slot1[slot8], slot4[slot8]))
	end

	return 
end
slot0.refreshMiniMap = function (slot0)
	for slot4, slot5 in ipairs(slot0.getCustomChildren(slot0, slot0.mapNode, "cityId")) do
		slot5.removeFromParent(slot5)

		slot5 = nil
	end

	slot1 = PlayerAttrObj:getPlayerAttrByName("GuildInfo")
	slot2 = 4
	slot3 = {
		"bp_54.png",
		"bp_55.png",
		"bp_92.png"
	}
	slot4 = {
		"bp_94.png",
		"bp_95.png",
		"bp_93.png"
	}
	slot5 = {
		"80,80",
		"100,100",
		"120,120",
		"140,140",
		"140,140"
	}

	for slot9 = #slot0.cityIdInfo, 1, -1 do
		for slot14, slot15 in ipairs(slot10) do
			slot20 = cc.size(slot23, slot24)
			slot19 = cc.p(slot25, slot26)
			slot27 = ""

			for slot31, slot32 in ipairs(slot0.cityIdInfo) do
				for slot36, slot37 in pairs(slot0.cityIdInfo[slot31]) do
					if tonumber(slot37) == tonumber(slot15) then
						if slot17 == slot2 then
							slot27 = slot4[slot31]

							break
						end

						slot27 = slot3[slot31]

						break
					end
				end
			end

			slot28 = {
				0.55,
				0.8,
				1,
				1
			}

			if slot0.ArmyAttackInfo and slot0.ArmyAttackInfo.State and slot0.ArmyAttackInfo.State ~= Enums.ArmystrikesType.eClosed and table.indexof(slot0.ArmyAttackInfo.ArmyAttackCitys, slot16) then
				slot27 = "bp_101.png"
			end

			UIWrap.newControl("Button", {
				image = slot27,
				pos = slot19,
				scale = slot28[slot17],
				clickAction = function (slot0)
					if slot0.callback then
						slot0.callback(slot0.callback)
						LayerManager.removeLayer(slot0)
					else
						LayerManager.addLayer({
							name = "citywar.CityWarHomeLayer",
							data = {
								defaultCityId = LayerManager.addLayer
							}
						})
					end

					return 
				end
			}).cityId = slot16

			slot0.mapNode:addChild(UIWrap.newControl("Button", {
				image = slot27,
				pos = slot19,
				scale = slot28[slot17],
				clickAction = function (slot0)
					if slot0.callback then
						slot0.callback(slot0.callback)
						LayerManager.removeLayer(slot0)
					else
						LayerManager.addLayer({
							name = "citywar.CityWarHomeLayer",
							data = {
								defaultCityId = LayerManager.addLayer
							}
						})
					end

					return 
				end
			}))

			if slot9 == 1 then
				slot29.addChild(slot29, UIWrap.newControl("Effect", {
					loop = true,
					scale = 0.8,
					dataFile = "effect_ui_dituyilan"
				}))
			end

			if slot0.ArmyAttackInfo and slot0.ArmyAttackInfo.State and slot0.ArmyAttackInfo.State ~= Enums.ArmystrikesType.eClosed and table.indexof(slot0.ArmyAttackInfo.ArmyAttackCitys, slot16) then
				slot29.addChild(slot29, UIWrap.newControl("Effect", {
					loop = true,
					dataFile = "effect_ui_mojiaoruqin_xiaochengbiao"
				}))
			end
		end
	end

	return 
end
slot0.refreshBottomUI = function (slot0)
	slot0.getNumLabel:setString(TR("我方已占领#8ba857%s#000000座门派", #slot0.cityIdInfo[1]))

	slot1 = 0

	for slot5, slot6 in ipairs(slot0.cityIdInfo[1]) do
		if CitywarCityConfig.items[tonumber(slot6)].cityType <= 3 then
			slot1 = slot1 + DemesneProfitRelation.items[slot7].guildReward
		end
	end

	return 
end
slot0.onCityRewardCallback = function (slot0, slot1)
	if #slot0.cityIdInfo[1] == 0 then
		ui.showFlashView("请先攻占一座门派！")

		return 
	end

	slot2 = {}

	for slot6, slot7 in pairs(slot0.cityIdInfo[1]) do
		if CitywarCityConfig.items[tonumber(slot7)].cityType <= 3 then
			table.insert(slot2, slot7)
		end
	end

	LayerManager.addLayer({
		cleanUp = false,
		name = "guild.GuildCityRewardLayer",
		data = {
			allCityInfo = slot0.allCityInfo.CityInfo,
			ownCityIdInfo = slot2
		},
		zOrder = Enums.ZOrderType.ePopLayer
	})

	return 
end
slot0.isGuildChangeValid = function (slot0)
	if not Utility.isEntityId(PlayerAttrObj:getPlayerAttrByName("GuildInfo").GuildId) then
		ui.showFlashView("请先加入帮派！")

		return 
	end

	if #slot0.cityIdInfo[1] == 0 then
		ui.showFlashView("当前帮派未占领门派")

		return 
	end

	if slot0 < slot1.PositionId then
		ui.showFlashView("无权进入")

		return 
	end

	return true
end
slot0.onGiveUpCallback = function (slot0, slot1)
	if slot0.isGuildChangeValid(slot0) then
		LayerManager.addLayer({
			cleanUp = false,
			name = "guild.GuildGiveUpCityLayer",
			data = {
				layerType = 1,
				allCityInfo = slot0.allCityInfo.CityInfo,
				ownCityIdInfo = slot0.cityIdInfo[1],
				giveUpCityNum = slot0.allCityInfo.GiveUpCityNum or 0,
				mainCityId = slot0.allCityInfo.MainCityId,
				closeUpdateFunc = function ()
					slot0:getCityWarInfo()

					return 
				end
			},
			zOrder = Enums.ZOrderType.ePopLayer
		})
	end

	return 
end
slot0.onCitySpeicaltyCallback = function (slot0, slot1)
	LayerManager.addLayer({
		cleanUp = false,
		name = "guild.GuildGiveUpCityLayer",
		data = {
			layerType = 2,
			spInfo = slot0.allCityInfo.SpInfo,
			mainCityId = slot0.allCityInfo.MainCityId,
			allCityInfo = slot0.allCityInfo.CityInfo
		},
		zOrder = Enums.ZOrderType.ePopLayer
	})

	return 
end
slot0.onChangeHomeBtn = function (slot0)
	if slot0.isGuildChangeValid(slot0) then
		LayerManager.addLayer({
			cleanUp = false,
			name = "guild.GuildGiveUpCityLayer",
			data = {
				layerType = 3,
				allCityInfo = slot0.allCityInfo.CityInfo,
				ownCityIdInfo = slot0.cityIdInfo[1],
				giveUpCityNum = slot0.allCityInfo.GiveUpCityNum or 0,
				mainCityId = slot0.allCityInfo.MainCityId,
				closeUpdateFunc = function ()
					slot0:getCityWarInfo()

					return 
				end
			},
			zOrder = Enums.ZOrderType.ePopLayer
		})
	end

	return 
end
slot0.getCityWarInfo = function (slot0)
	slot0.socketRequest(slot0, {
		methodName = "GetCityInfo",
		moduleName = "Citywar",
		methodData = {
			0
		},
		successCallback = function (slot0)
			slot0.allCityInfo = {}
			slot0.cityIdInfo = {
				{},
				{},
				{}
			}
			slot0.bornCityId = slot0.MainCityId
			slot0.allCityInfo = slot0
			slot0.attackRoutes = slot0.Route
			slot1 = PlayerAttrObj:getPlayerAttrByName("GuildInfo")

			for slot5, slot6 in pairs(slot0.CityInfo) do
				if slot6.Logo == "" and slot6.BannerInfo == "" and slot6.CityStatusInfo.Status == 1 then
					table.insert(slot0.cityIdInfo[2], slot5)
				elseif Utility.isEntityId(slot1.GuildId) and slot6.Logo == slot1.Logo and slot6.BannerInfo == slot1.Flag and slot6.GuildId == slot1.GuildId then
					table.insert(slot0.cityIdInfo[1], slot5)
				else
					table.insert(slot0.cityIdInfo[3], slot5)
				end
			end

			slot0:refreshTopCityNum()
			slot0:refreshMiniMap()
			slot0:refreshBottomUI()

			return 
		end
	})

	return 
end
slot0.requestWorldBossInfo = function (slot0)
	if not Utility.moduleIsOpen(ModuleSub.eWorldBoss, false) or PlayerAttrObj:getPlayerAttrByName("ServerOpenDays") <= CitymonsterConfig.items[1].openNeedDay then
		return 
	end

	slot0.socketRequest(slot0, {
		methodName = "GetArmyInfo",
		moduleName = "Citywar",
		svrMethodData = {},
		successCallback = function (slot0)
			slot0.ArmyAttackInfo = slot0

			return 
		end
	})

	return 
end

return slot0
